name: CI

on:
  pull_request:
  workflow_dispatch:
  schedule:
    # at 8:00 every 1st of the month
    - cron: 0 8 1 * *

jobs:
  test:
    name: "ðŸ“¦ Build & install"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container:
          - "registry.fedoraproject.org/fedora:latest"
          - "registry.fedoraproject.org/fedora:rawhide"
          - "quay.io/centos/centos:stream9"
          - "quay.io/centos/centos:stream10"
    container:
      image: ${{ matrix.container }}

    steps:
    - name: Base setup
      run: |
        dnf --setopt install_weak_deps=False install -y \
            dnf-plugins-core \
            git-core \
            rpm-build \
            sudo

        dnf remove -y subscription-manager-rhsm-certificates

        git config --global user.email "actions@github.com"
        git config --global user.name "Github Actions"

    - name: Get container name & version
      id: container-name
      run: |
        name=${{ matrix.container }}
        name=${name##*/}
        name=${name//:/-}
        echo "name=${name}" >> $GITHUB_OUTPUT

    - name: Setup EPEL 9
      if: ${{ endsWith(matrix.container, 'stream9') }}
      run: |
        dnf config-manager --set-enabled crb
        dnf install -y epel-release epel-next-release

    - name: Setup EPEL 10
      if: ${{ endsWith(matrix.container, 'stream10') }}
      run: |
        dnf config-manager --set-enabled crb
        dnf install -y epel-release

    - name: Install tito (using pip)
      run: |
        dnf --setopt install_weak_deps=False install -y \
          python3-pip python3-setuptools
        pip install https://github.com/rpm-software-management/tito/archive/refs/tags/tito-0.6.27-1.tar.gz

    - uses: actions/checkout@v5

    # This step is required so Tito can properly read git history
    # See https://github.com/actions/checkout/issues/766
    - name: Trust git repository path
      run: |
        git config --global --add safe.directory '*'

    - name: Install RPM build dependencies
      run: |
        dnf --setopt install_weak_deps=False builddep -y \
            --spec ./subscription-manager-rhsm-certificates.spec

    - name: tito build --install
      run: |
        mkdir tito
        tito build --offline --test --rpm --install --output=tito

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RPMs for ${{ steps.container-name.outputs.name }}
        path: |
          tito/
